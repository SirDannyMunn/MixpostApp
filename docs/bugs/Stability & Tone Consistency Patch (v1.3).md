Here is the engineering specification to resolve the "Repair Loop" stability issue and the lingering "System Tone" conflict.

# Engineering Spec: Stability & Tone Consistency Patch (v1.3)

**Priority:** Critical (Affects Success Rate & Quality)
**Owner:** Backend/AI Engineering
**Objective:** Prevent the system from validating empty content (which leads to "refusal" posts) and ensure the Voice Profile is the single source of truth for tone in the System Prompt.

---

## 1. Fix A: The "Repair Loop" Prevention

**Component:** `App\Services\Ai\ContentGeneratorService`

### 1.1 Problem Description

Currently, if the primary generation returns an empty string (due to parsing failure or model refusal), the pipeline passes this empty string to the `ValidationAndRepairService`.

1. **Input:** `""` (Empty String)
2. **Action:** The Repair Prompt asks the LLM to "Fix this draft."
3. **Result:** The LLM, having no text to fix, politely replies *"I cannot edit an empty draft."*
4. **Outcome:** The system saves this refusal message as the final post.

### 1.2 Technical Requirement

Implement a **"Circuit Breaker"** pattern. The system must verify the draft exists *before* attempting validation or repair.

**Logic Flow:**

1. **Generate:** Run primary generation.
2. **Check:** Is the output empty?
* **YES:** Skip `ValidationAndRepair`. Trigger `regenerateFromContext` immediately.
* **NO:** Proceed to `ValidationAndRepair`.



### 1.3 Implementation Details (`ContentGeneratorService.php`)

Locate the section immediately following the `$runner->runJsonContentCall` execution.

```php
// ... after primary generation ...
$draft = (string) ($gen['content'] ?? '');

// --- NEW LOGIC START ---
// Circuit Breaker: Never send an empty draft to the Validator/Repair service.
if (trim($draft) === '') {
    Log::warning('content.generator.empty_draft_detected', ['stage' => 'pre_validation']);
    
    // Trigger Emergency Regeneration immediately
    [$draft, $regenMeta] = $this->regenerateFromContext($promptObj->system, $promptObj->user);
    
    // Validate the *regenerated* content, not the empty one
    if (trim($draft) !== '') {
         $validation = $this->validator->checkPost($draft, $context);
    } else {
         // If it's STILL empty, we fail gracefully or use emergencyCompose
         $validation = ['ok' => false, 'issues' => ['generation_failed']];
    }
} 
else {
    // Normal Flow: Draft exists, so we attempt to validate and repair it
    $res = $this->validatorRepair->validateAndRepair($draft, $context, $constraints);
    $draft = $res['content'];
    $validation = $res['validation'];
}
// --- NEW LOGIC END ---

```

---

## 2. Fix B: System Prompt Tone Hierarchy

**Component:** `App\Services\Ai\Generation\Steps\PromptComposer`

### 2.1 Problem Description

While we fixed the *User Context* tone, the *System Prompt* still hardcodes the `tone` constraint from the options settings (defaulting to "professional").

**Current System Prompt:**

> `Constraints: max_chars=1200; emoji=allow; tone=professional.`
> `VOICE_SIGNATURE: - Tone: casual, playful...`

**The Conflict:** The model receives two opposing instructions: "Be professional" vs. "Be playful/boastful." This causes "Hallucinated Tone" where the model oscillates between the two.

### 2.2 Technical Requirement

The `PromptComposer` must respect the Voice Profile hierarchy. If a Voice Profile is active, the explicit `tone` constraint in the System Prompt must be replaced with a directive to follow the voice.

### 2.3 Implementation Details (`PromptComposer.php`)

Modify `composePostGeneration`:

```php
public function composePostGeneration(GenerationContext $context, Constraints $c, string $prompt): Prompt
{
    // 1. Determine Tone Instruction
    // If a voice is present, the tone constraint should strictly point to the voice.
    // Otherwise, use the standard constraint from options (e.g., 'professional').
    $toneInstruction = !empty($context->voice) 
        ? 'adhere to VOICE_SIGNATURE' 
        : $c->tone;

    $system = "You are an expert social writer. Return STRICT JSON only...\n";
    
    // 2. Inject Modified Constraint
    $system .= "Constraints: max_chars={$c->maxChars}; emoji={$c->emojiPolicy}; tone={$toneInstruction}.";

    // ... rest of logic (appending Voice Signature block) ...
}

```

---

## 3. Acceptance Criteria (Verification)

### Test Case 1: The "Empty Response" Recovery

* **Action:** Simulate an empty response from the `GenerationRunner` (mock or force return `null`).
* **Expectation:**
1. The logs show `content.generator.empty_draft_detected`.
2. The `repair_metrics.count` in the snapshot is **0** (because it shouldn't try to repair empty text).
3. The final output is a valid post (generated by the fallback), **NOT** a text saying "I cannot edit this."



### Test Case 2: The "Jacky Chou" Tone Check

* **Action:** Replay the Jacky Chou snapshot.
* **Expectation:** Check the `compiled_system_prompt` (or `final_system_prompt`) in the DB/logs.
* **BAD:** `tone=professional`
* **GOOD:** `tone=adhere to VOICE_SIGNATURE`



---

## 4. Summary of Code Changes

| File | Change | Reason |
| --- | --- | --- |
| `ContentGeneratorService.php` | Add `if (empty($draft))` check before `validateAndRepair` | Prevents the "I can't edit nothing" robotic response loop. |
| `PromptComposer.php` | Logic to swap `$c->tone` string if Voice is present | Removes the conflict between "Professional" constraints and "Casual" voice traits. |